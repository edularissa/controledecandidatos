<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>OGSM Dashboard v2.0</title>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css">

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: "Inter", sans-serif; background: #f3f5f7; padding-bottom: 80px; }

        .header {
            background: linear-gradient(135deg,#3b6cb7,#4a90e2);
            padding: 22px; color: white; display:flex; gap:15px;
            position:sticky; top:0; z-index:20; align-items:center;
        }

        .container { padding: 20px; max-width: 900px; margin: auto; }

        .goal-card {
            background:#fff; padding:25px; border-radius:18px; margin-bottom:35px;
            box-shadow:0 5px 18px rgba(0,0,0,0.09); transition:.25s;
        }
        .goal-card:hover { transform:translateY(-4px); }

        .strategic-card {
            background:#f6f8fb; padding:18px; border-radius:14px;
            margin-top:18px; border-left:8px solid #4a90e2; cursor:pointer;
        }

        .strategic-content { margin-top:15px; display:none; }

        .activity {
            background:#fff; padding:16px; border-radius:12px;
            margin-bottom:12px; border-left:6px solid #7b61ff;
            box-shadow:0 2px 10px rgba(0,0,0,0.05);
        }

        .status-indicador {
            font-size: 16px;
            margin-left: 8px;
        }

        .btn {
            padding:10px; border:none; border-radius:8px;
            cursor:pointer; margin-top:12px;
        }

        .btn-primary { background:#4a90e2; color:white; }
        .btn-danger { background:#d9534f; color:white; }
    </style>
</head>

<body>

<div class="header">
    <i class="bi bi-kanban"></i>
    <h2 style="margin-right:auto;">OGSM Dashboard</h2>

    <!-- BOTÃO PARA CRIAR NOVO GOAL -->
    <button onclick="abrirFormGoal()" class="btn btn-primary">+ Novo Goal</button>
</div>

<div class="container" id="lista-goals">
    <!-- GOALS DO FIRESTORE APARECEM AQUI -->
</div>

<!-- -----------------------
     MODAL DE GOAL
------------------------ -->
<div id="modalGoal" style="
    display:none; position:fixed; top:0; left:0; width:100%; height:100%;
    background:rgba(0,0,0,0.55); display:flex; align-items:center;
    justify-content:center; z-index:999;">
    
    <div style="background:white; padding:25px; width:420px; border-radius:14px;">
        <h2 id="tituloGoalForm">Novo Goal</h2>

        <label>Título do Goal</label>
        <input id="goalTitulo" type="text" style="width:100%; padding:8px; margin-top:10px;">

        <button onclick="salvarGoal()" class="btn btn-primary" style="width:100%; margin-top:20px;">Salvar</button>
        <button onclick="fecharModalGoal()" class="btn" style="width:100%; background:#ccc; margin-top:10px;">Cancelar</button>
    </div>
</div>

<!-- -----------------------
     MODAL DE ATIVIDADES
------------------------ -->
<div id="modalAtividade" style="
    display:none; position:fixed; top:0; left:0; width:100%; height:100%;
    background:rgba(0,0,0,0.55); display:flex; align-items:center;
    justify-content:center; z-index:999;">
    
    <div style="background:white; padding:25px; width:420px; border-radius:14px;">
        <h2 id="tituloAtividadeForm">Nova Atividade</h2>

        <label>Título</label>
        <input id="a_titulo" type="text" style="width:100%; padding:8px; margin-bottom:12px;">

        <label>Responsável</label>
        <input id="a_resp" type="text" style="width:100%; padding:8px; margin-bottom:12px;">

        <label>Prazo</label>
        <input id="a_prazo" type="date" style="width:100%; padding:8px; margin-bottom:12px;">

        <label>Status</label>
        <select id="a_status" style="width:100%; padding:8px; margin-bottom:12px;">
            <option>Não iniciado</option>
            <option>Em andamento</option>
            <option>Concluído</option>
        </select>

        <label>Acompanhamento</label>
        <textarea id="a_acomp" rows="4" style="width:100%; padding:8px;"></textarea>

        <button onclick="salvarAtividade()" class="btn btn-primary" style="width:100%; margin-top:20px;">Salvar</button>
        <button onclick="fecharModalAtividade()" class="btn" style="width:100%; background:#ccc; margin-top:10px;">Cancelar</button>
    </div>
</div>



<!-- ================================
       FIREBASE SCRIPT
================================ -->
<script type="module">

/* -------------------------------------
     CONFIG FIREBASE
-------------------------------------- */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { 
    getFirestore, collection, addDoc, getDocs, updateDoc, deleteDoc, doc 
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
    apiKey: "AIzaSyBRVfdcyHllNOuGc-tp-sFuh8UA9S1uOOE",
    authDomain: "ogsm-792b5.firebaseapp.com",
    projectId: "ogsm-792b5",
    storageBucket: "ogsm-792b5.firebasestorage.app",
    messagingSenderId: "434808646939",
    appId: "1:434808646939:web:fa9d54d416b469a09e77be",
    measurementId: "G-LMSNGB64CH"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);


/* -------------------------------------
      CARREGAR TODOS OS GOALS
-------------------------------------- */
async function carregarGoals() {
    const container = document.getElementById("lista-goals");
    container.innerHTML = "";

    const q = await getDocs(collection(db, "goals"));

    q.forEach(async goalDoc => {
        const goal = goalDoc.data();

        container.innerHTML += `
            <div class="goal-card" id="goal-${goalDoc.id}">
                <h2><i class="bi bi-bullseye"></i> ${goal.titulo}</h2>

                <div class="strategic-card" onclick="toggleContent(this)">
                    <div class="strategic-title">
                        <span>Atividades</span>
                        <i class="bi bi-chevron-down arrow"></i>
                    </div>

                    <div class="strategic-content" id="ativ-${goalDoc.id}">
                        <p>Carregando atividades...</p>
                    </div>

                    <button onclick="abrirFormAtividade(event, '${goalDoc.id}')" 
                            class="btn btn-primary">
                        + Nova Atividade
                    </button>
                </div>

                <button onclick="excluirGoal('${goalDoc.id}')" class="btn btn-danger" style="margin-top:15px;">Excluir Goal</button>
            </div>
        `;

        carregarAtividades(goalDoc.id);
    });
}

carregarGoals();



/* -------------------------------------
     CARREGAR ATIVIDADES DO GOAL
-------------------------------------- */
async function carregarAtividades(goalId) {
    const lista = document.getElementById("ativ-" + goalId);
    lista.innerHTML = "";

    const atividadesRef = collection(db, "goals", goalId, "atividades");
    const q = await getDocs(atividadesRef);

    q.forEach(ativDoc => {
        const a = ativDoc.data();

        const hoje = new Date();
        const prazo = new Date(a.prazo);
        const atrasada = prazo < hoje && a.status !== "Concluído";

        const indicador = atrasada 
            ? "<span class='status-indicador' style='color:red'>●</span>"
            : "<span class='status-indicador' style='color:green'>●</span>";

        lista.innerHTML += `
            <div class="activity">
                <div><b>Título:</b> ${a.titulo} ${indicador}</div>
                <div><b>Responsável:</b> ${a.responsavel}</div>
                <div><b>Prazo:</b> ${a.prazo}</div>
                <div><b>Status:</b> ${a.status}</div>
                <div><b>Acompanhamento:</b> ${a.acompanhamento}</div>

                <button class="btn btn-primary" onclick="editarAtividade('${goalId}','${ativDoc.id}','${a.titulo}','${a.responsavel}','${a.prazo}','${a.status}','${a.acompanhamento}')">Editar</button>
                <button class="btn btn-danger" onclick="excluirAtividade('${goalId}','${ativDoc.id}')">Excluir</button>
            </div>
        `;
    });
}



/* -------------------------------------
     CRUD - GOALS
-------------------------------------- */
let goalEditId = null;

window.abrirFormGoal = function() {
    goalEditId = null;
    document.getElementById("tituloGoalForm").innerText = "Novo Goal";
    document.getElementById("goalTitulo").value = "";
    document.getElementById("modalGoal").style.display = "flex";
};

window.fecharModalGoal = function() {
    document.getElementById("modalGoal").style.display = "none";
};

window.salvarGoal = async function() {
    const titulo = document.getElementById("goalTitulo").value;

    if (!titulo.trim()) return alert("Digite um título");

    await addDoc(collection(db, "goals"), { titulo });

    fecharModalGoal();
    carregarGoals();
};

window.excluirGoal = async function(id) {
    if (!confirm("Excluir este goal?")) return;

    await deleteDoc(doc(db, "goals", id));
    carregarGoals();
};



/* -------------------------------------
     CRUD - ATIVIDADES
-------------------------------------- */
let currentGoalId = null;
let atividadeEditId = null;

window.abrirFormAtividade = function(event, goalId) {
    event.stopPropagation();

    atividadeEditId = null;
    currentGoalId = goalId;

    document.getElementById("tituloAtividadeForm").innerText = "Nova Atividade";

    document.getElementById("a_titulo").value = "";
    document.getElementById("a_resp").value = "";
    document.getElementById("a_prazo").value = "";
    document.getElementById("a_status").value = "Não iniciado";
    document.getElementById("a_acomp").value = "";

    document.getElementById("modalAtividade").style.display = "flex";
};

window.editarAtividade = function(goalId, ativId, titulo, resp, prazo, status, acomp) {
    atividadeEditId = ativId;
    currentGoalId = goalId;

    document.getElementById("tituloAtividadeForm").innerText = "Editar Atividade";

    document.getElementById("a_titulo").value = titulo;
    document.getElementById("a_resp").value = resp;
    document.getElementById("a_prazo").value = prazo;
    document.getElementById("a_status").value = status;
    document.getElementById("a_acomp").value = acomp;

    document.getElementById("modalAtividade").style.display = "flex";
};

window.fecharModalAtividade = function() {
    document.getElementById("modalAtividade").style.display = "none";
};

window.salvarAtividade = async function() {

    const dados = {
        titulo: document.getElementById("a_titulo").value,
        responsavel: document.getElementById("a_resp").value,
        prazo: document.getElementById("a_prazo").value,
        status: document.getElementById("a_status").value,
        acompanhamento: document.getElementById("a_acomp").value
    };

    const atividadesRef = collection(db, "goals", currentGoalId, "atividades");

    if (atividadeEditId) {
        const ref = doc(db, "goals", currentGoalId, "atividades", atividadeEditId);
        await updateDoc(ref, dados);
    } else {
        await addDoc(atividadesRef, dados);
    }

    fecharModalAtividade();
    carregarAtividades(currentGoalId);
};

window.excluirAtividade = async function(goalId, ativId) {
    if (!confirm("Excluir atividade?")) return;

    const ref = doc(db, "goals", goalId, "atividades", ativId);
    await deleteDoc(ref);

    carregarAtividades(goalId);
};



/* -------------------------------------
     ACORDEÃO
-------------------------------------- */
window.toggleContent = function(card) {
    const content = card.querySelector(".strategic-content");
    const arrow = card.querySelector(".arrow");

    if (content.style.display === "block") {
        content.style.display = "none";
        arrow.style.transform = "rotate(0deg)";
    } else {
        content.style.display = "block";
        arrow.style.transform = "rotate(180deg)";
    }
};

</script>

</body>
</html>
