<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title> Vagas & Candidatos</title>

  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

  <style>
    :root{
      --bg:#0f172a;           /* slate-900 */
      --panel:#111827;        /* gray-900 */
      --muted:#1f2937;        /* gray-800 */
      --soft:#374151;         /* gray-700 */
      --accent:#22c55e;       /* green-500 */
      --accent-2:#06b6d4;     /* cyan-500 */
      --text:#e5e7eb;         /* gray-200 */
      --text-dim:#9ca3af;     /* gray-400 */
      --danger:#ef4444;       /* red-500 */
      --warn:#f59e0b;         /* amber-500 */
      --ok:#10b981;           /* emerald-500 */
      --radius:12px;
      --radius-sm:10px;
      --shadow:0 12px 30px rgba(0,0,0,.25);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:linear-gradient(180deg,#0b1225,#0f172a 30%,#0b1225);
      color:var(--text); font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }
    .app{
      display:grid; grid-template-columns:320px 1fr; gap:16px;
      padding:16px; height:100%;
    }
    header{
      grid-column:1/-1; display:flex; gap:12px; align-items:center; justify-content:space-between;
      background:rgba(17,24,39,.7); border:1px solid rgba(255,255,255,.06);
      padding:14px 16px; border-radius:var(--radius); backdrop-filter: blur(12px);
      box-shadow: var(--shadow);
    }
    .brand{display:flex; align-items:center; gap:10px; font-weight:700; letter-spacing:.3px}
    .pill{
      padding:4px 10px; border-radius:100px; background:linear-gradient(90deg,var(--accent),var(--accent-2));
      color:#061016; font-weight:700; font-size:12px;
    }
    .toolbar{display:flex; gap:8px; flex-wrap:wrap}
    .btn{
      background:var(--muted); color:var(--text); border:1px solid rgba(255,255,255,.06);
      padding:10px 12px; border-radius:10px; cursor:pointer; font-weight:600;
    }
    .btn:hover{background:#263043}
    .btn.primary{background:linear-gradient(90deg,var(--accent-2),var(--accent)); color:#081018; border:none}
    .btn.danger{background:linear-gradient(90deg,#ef4444,#f97316); color:#1b0c0a; border:none}
    .btn.ghost{background:transparent; border:1px dashed rgba(255,255,255,.15)}
    .btn.small{padding:8px 10px; font-size:12px}
    .btn.block{width:100%}

    /* Coluna esquerda (Vagas) */
    .sidebar{
      background:rgba(17,24,39,.7); border:1px solid rgba(255,255,255,.06);
      padding:14px; border-radius:var(--radius); display:flex; flex-direction:column; gap:12px;
      box-shadow:var(--shadow);
      min-height:0; /* para overflow funcionar */
    }
    .sidebar h2{margin:0 0 6px 0; font-size:16px; color:var(--text-dim); font-weight:600}
    .jobs-list{
      display:flex; flex-direction:column; gap:8px; overflow:auto; min-height:0;
    }

    /* === AJUSTES FEITOS AQUI PARA CORRIGIR O LAYOUT DO CARD === */
    .job-card{
      background:var(--muted);
      border:1px solid rgba(255,255,255,.06);
      padding:12px;
      border-radius:var(--radius-sm);
      cursor:pointer;
      display:flex; /* Mudança para flexbox */
      flex-direction: column; /* Organiza os itens em coluna */
      align-items: center; /* Alinha o conteúdo ao centro */
      gap:6px;
      max-height: 120px; /* Limita a altura do card */
      text-align: center; /* Centraliza o texto */
    }

    /* Garante que o título não quebre em muitas linhas */
    .job-title{
      font-weight:700;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    /* Corrige o layout do badge */
    .badge {
      background:rgba(255,255,255,.06);
      padding:2px 8px;
      border-radius:100px;
      font-size:12px;
      flex-shrink: 0; /* Impede que o badge encolha */
    }

    /* Ajusta a descrição para ter no máximo 2 linhas */
    .job-desc{
      color:var(--text-dim);
      font-size:13px;
      line-height:1.3;
      display: -webkit-box;
      -webkit-line-clamp: 2; /* Limita a 2 linhas */
      -webkit-box-orient: vertical;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    /* ========================================================= */

    .empty{color:var(--text-dim); font-size:13px; text-align:center; padding:10px}

    /* Área principal */
    .main{
      background:rgba(17,24,39,.7); border:1px solid rgba(255,255,255,.06);
      padding:14px; border-radius:var(--radius); display:flex; flex-direction:column; gap:12px;
      box-shadow:var(--shadow);
      min-width:0; min-height:0;
    }
    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .grow{flex:1}
    input, textarea{
      width:100%; background:#0b1220; color:var(--text);
      border:1px solid rgba(255,255,255,.08); border-radius:10px; padding:10px 12px;
    }
    textarea{min-height:80px; resize:vertical}
    .input{display:flex; flex-direction:column; gap:6px}
    label{font-size:12px; color:var(--text-dim)}
    .chips{display:flex; flex-wrap:wrap; gap:6px}
    .chip{
      background:#0b1220; border:1px dashed rgba(255,255,255,.14); padding:6px 10px; border-radius:100px; font-size:12px;
      display:flex; align-items:center; gap:6px;
    }
    .chip .x{cursor:pointer; opacity:.8}
    .muted{color:var(--text-dim)}
    .divider{height:1px; background:linear-gradient(90deg,transparent,rgba(255,255,255,.06),transparent); margin:8px 0}

    /* Kanban */
    .kanban{
      display:grid; grid-template-columns:repeat(auto-fit,minmax(260px,1fr)); gap:12px; align-items:start;
      overflow:auto; padding-bottom:8px;
    }
    .col{
      background:var(--panel); border:1px solid rgba(255,255,255,.06); border-radius:var(--radius);
      min-height:140px; display:flex; flex-direction:column; gap:8px; padding:10px;
    }
    .col-header{display:flex; align-items:center; justify-content:space-between}
    .badge{background:rgba(255,255,255,.06); padding:2px 8px; border-radius:100px; font-size:12px}
    .dropzone{
      min-height:80px; border:2px dashed rgba(255,255,255,.1); border-radius:10px; padding:6px; transition:.15s;
    }
    .dropzone.hover{border-color:var(--accent)}
    .card{
      background:var(--muted); border:1px solid rgba(255,255,255,.08);
      padding:10px; border-radius:10px; display:grid; gap:6px; cursor:grab;
    }
    .card:active{cursor:grabbing}
    .card .title{font-weight:700}
    .card .meta{font-size:12px; color:var(--text-dim)}
    .card .notes{font-size:12px; color:var(--text)}
    .card .row{justify-content:space-between}
    .nowrap{white-space:nowrap; overflow:hidden; text-overflow:ellipsis}

    .footer{opacity:.8; font-size:12px; text-align:center; padding-top:4px}
    @media (max-width: 920px){
      .app{grid-template-columns:1fr}
      header{position:sticky; top:0; z-index:5}
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="brand">
        <img src="https://i.ibb.co/vvC2vLJs/icone-do-logotipo-branco-transparente-termotubos.png" alt="Logo da Termotubos" style="height: 24px;"> Vagas & Candidatos
      </div>
      <div class="toolbar">
        <button class="btn small" id="exportBtn">Exportar JSON</button>
        <label class="btn small ghost" for="importFile">Importar JSON</label>
        <input id="importFile" type="file" accept="application/json" style="display:none"/>
        <button class="btn small danger" id="resetBtn" title="Apagar tudo">Reset</button>
      </div>
    </header>

        <aside class="sidebar">
      <h2>Vagas</h2>
      <div class="row">
        <input id="jobTitle" placeholder="Título da vaga (ex.: Assistente de DHO)"/>
      </div>
      <div class="row">
        <input id="jobDesc" placeholder="Descrição (resumo curto da vaga)"/>
      </div>
      <div class="row">
        <input id="jobStages" placeholder="Etapas separadas por vírgula (ex.: Recebidos,Triagem,Entrevista,Oferta)"/>
      </div>
      <div class="row">
        <button class="btn primary block" id="addJobBtn">Criar vaga</button>
      </div>

      <div class="divider"></div>
      <div class="row">
        <input id="jobSearch" placeholder="Buscar vaga por título..."/>
      </div>

      <div class="jobs-list" id="jobsList"></div>
      <div class="footer muted">Dica: você pode editar as etapas depois, dentro da vaga.</div>
    </aside>

        <main class="main">
      <div id="emptyMain" class="empty">Selecione ou crie uma vaga para começar.</div>

      <div id="jobView" style="display:none">
        <div class="row">
          <div class="input grow">
            <label>Título da vaga</label>
            <input id="editJobTitle"/>
          </div>
          <div class="input grow">
            <label>Descrição</label>
            <input id="editJobDesc"/>
          </div>
        </div>

        <div class="row">
          <div class="input grow">
            <label>Etapas do processo (pressione Enter para adicionar)</label>
            <div class="row">
              <input id="stageInput" placeholder="Nova etapa..." />
              <button class="btn" id="addStageBtn">Adicionar etapa</button>
            </div>
            <div id="stagesChips" class="chips"></div>
            <div class="muted" style="font-size:12px">Arraste candidatos entre etapas no Kanban.</div>
          </div>
        </div>

        <div class="divider"></div>

        <div class="row">
          <div class="input grow">
            <label>Adicionar candidato</label>
            <input id="candName" placeholder="Nome completo"/>
          </div>
          <div class="input grow">
            <label>Contato</label>
            <input id="candContact" placeholder="E-mail, telefone ou @"/>
          </div>
          <div class="input grow">
            <label>Currículo (URL opcional)</label>
            <input id="candCV" placeholder="https://..." />
          </div>
          <button class="btn primary" id="addCandBtn" title="Adiciona na primeira etapa">+ Candidato</button>
        </div>
        <div class="row">
          <div class="input grow">
            <label>Observações (serão salvas no cartão do candidato ao criar)</label>
            <textarea id="candNotes" placeholder="Ex.: indicado pelo João, pedir pretensão salarial..."></textarea>
          </div>
        </div>

        <div class="row">
          <input id="searchCand" class="grow" placeholder="Buscar candidato por nome/contato/notas..."/>
          <button class="btn ghost" id="deleteJobBtn" title="Excluir vaga atual">Excluir vaga</button>
        </div>

        <section id="kanban" class="kanban"></section>
      </div>
    </main>
  </div>

 <script>
    /***********************
     * Mini ATS — lógica com Firebase
     ***********************/

    // SEU CÓDIGO DE CONFIGURAÇÃO DO FIREBASE
    const firebaseConfig = {
      apiKey: "AIzaSyDFJSkoKJPRsCBmxHR-ye4W7JEj6KtOEtI",
      authDomain: "gestao-de-candidatos-9210c.firebaseapp.com",
      projectId: "gestao-de-candidatos-9210c",
      storageBucket: "gestao-de-candidatos-9210c.firebasestorage.app",
      messagingSenderId: "832627853482",
      appId: "1:832627853482:web:4ca4ae8bc0023416cb68d3"
    };

    // Inicialização do Firebase e do Firestore
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // state agora será atualizado pelo Firebase
    let state = { jobs: [], selectedJobId: null };

    // Funções de persistência local (save, load, seed) não são mais usadas
    function uid(){
      return Math.random().toString(36).slice(2,9) + Date.now().toString(36).slice(-4);
    }
    
    /** @typedef {{id:string, title:string, description:string, stages:string[], candidates: Candidate[]}} Job */
    /** @typedef {{id:string, name:string, contact:string, cv?:string, notes?:string, stage:string, createdAt:number}} Candidate */

    function cand(name, contact, cv, stage, notes){
      return { id: uid(), name, contact, cv, notes, stage, createdAt: Date.now() };
    }

    function render(){
      renderJobsList();
      renderMain();
    }

    function renderJobsList(){
      const filter = (jobSearch.value||"").toLowerCase().trim();
      const list = state.jobs.filter(j => j.title.toLowerCase().includes(filter));
      jobsList.innerHTML = '';
      if (!list.length){
        const div = document.createElement('div');
        div.className = 'empty';
        div.textContent = 'Nenhuma vaga encontrada.';
        jobsList.appendChild(div);
        return;
      }
      list.forEach(job => {
        const card = document.createElement('div');
        card.className = 'job-card' + (state.selectedJobId===job.id?' active':'');
        card.innerHTML = `
          <div class="row" style="justify-content:space-between">
            <div class="job-title nowrap">${escapeHTML(job.title)}</div>
            <div class="badge">${job.candidates.length}</div>
          </div>
          <div class="job-desc nowrap">${escapeHTML(job.description||'Sem descrição')}</div>
        `;
        card.onclick = () => { state.selectedJobId = job.id; render(); };
        jobsList.appendChild(card);
      });
    }

    function renderMain(){
      const job = currentJob();
      if (!job){
        emptyMain.style.display = '';
        jobView.style.display = 'none';
        return;
      }
      emptyMain.style.display = 'none';
      jobView.style.display = '';

      editJobTitle.value = job.title;
      editJobDesc.value = job.description||'';
      renderStagesChips(job);
      renderKanban(job);
    }

    function renderStagesChips(job){
      stagesChips.innerHTML = '';
      job.stages.forEach((stg, idx) => {
        const chip = document.createElement('span');
        chip.className = 'chip';
        chip.innerHTML = `<span>${escapeHTML(stg)}</span><span class="x" title="Remover">✕</span>`;
        chip.querySelector('.x').onclick = async () => {
          const fallback = job.stages[idx-1] || job.stages[0];
          const newCandidates = job.candidates.map(c => c.stage===stg ? {...c, stage:fallback} : c);
          const newStages = job.stages.filter((_, i) => i !== idx);
          await db.collection("jobs").doc(job.id).update({ stages: newStages, candidates: newCandidates });
        };
        chip.ondblclick = async () => {
          const novo = prompt('Renomear etapa:', stg);
          if (!novo) return;
          const prev = stg;
          const newStages = job.stages.map(s => s === prev ? novo : s);
          const newCandidates = job.candidates.map(c => c.stage===prev ? {...c, stage:novo} : c);
          await db.collection("jobs").doc(job.id).update({ stages: newStages, candidates: newCandidates });
        };
        stagesChips.appendChild(chip);
      });
    }

    function renderKanban(job){
      const q = (searchCand.value||'').toLowerCase().trim();
      kanban.innerHTML = '';
      job.stages.forEach(stage => {
        const col = document.createElement('div');
        col.className = 'col';
        col.dataset.stage = stage;

        const header = document.createElement('div');
        header.className = 'col-header';
        header.innerHTML = `
          <div class="row" style="gap:8px">
            <strong>${escapeHTML(stage)}</strong>
          </div>
          <span class="badge" id="count-${cssId(stage)}">0</span>
        `;
        col.appendChild(header);

        const dropzone = document.createElement('div');
        dropzone.className = 'dropzone';
        dropzone.ondragover = (e)=>{ e.preventDefault(); dropzone.classList.add('hover'); };
        dropzone.ondragleave = ()=> dropzone.classList.remove('hover');
        dropzone.ondrop = (e)=>{
          e.preventDefault();
          dropzone.classList.remove('hover');
          const candId = e.dataTransfer.getData('text/plain');
          moveCandidate(job.id, candId, stage);
        };
        col.appendChild(dropzone);

        const list = job.candidates
          .filter(c => c.stage===stage)
          .filter(c => !q || (c.name+c.contact+(c.notes||'')).toLowerCase().includes(q))
          .sort((a,b)=>a.createdAt-b.createdAt);

        list.forEach(c => {
          const card = document.createElement('div');
          card.className = 'card';
          card.draggable = true;
          card.ondragstart = (e)=>{ e.dataTransfer.setData('text/plain', c.id); };
          card.innerHTML = `
            <div class="title nowrap">${escapeHTML(c.name)}</div>
            <div class="meta nowrap">${escapeHTML(c.contact||'')}</div>
            ${c.cv ? `<a href="${escapeAttr(c.cv)}" target="_blank" rel="noopener noreferrer" class="meta">Currículo</a>` : ''}
            ${c.notes ? `<div class="notes">${escapeHTML(c.notes)}</div>` : ''}
            <div class="row">
              <button class="btn small" data-action="edit">Editar</button>
              <div class="row" style="gap:6px">
                <button class="btn small ghost" data-action="note">+ Nota</button>
                <button class="btn small danger" data-action="del">Excluir</button>
              </div>
            </div>
          `;
          card.querySelector('[data-action="edit"]').onclick = ()=> editCandidate(job.id, c.id);
          card.querySelector('[data-action="note"]').onclick = ()=> addNote(job.id, c.id);
          card.querySelector('[data-action="del"]').onclick = ()=> deleteCandidate(job.id, c.id);
          dropzone.appendChild(card);
        });

        kanban.appendChild(col);
        // contador
        const count = list.length;
        header.querySelector(`#count-${cssId(stage)}`).textContent = count;
      });
    }

    /******************
     * Ações (Vagas)
     ******************/
    addJobBtn.onclick = async () => {
      const title = jobTitle.value.trim();
      if(!title){ alert('Informe um título para a vaga.'); return; }
      const description = jobDesc.value.trim();
      const stages = (jobStages.value || "Recebidos,Triagem,Entrevista,Contratados")
        .split(",")
        .map(s => s.trim())
        .filter(Boolean);
      const newJob = { title, description, stages, candidates: [] };
      await db.collection("jobs").add(newJob);
      jobTitle.value = jobDesc.value = jobStages.value = '';
    };

    editJobTitle.oninput = async () => {
      const job = currentJob(); if(!job) return;
      await db.collection("jobs").doc(job.id).update({ title: editJobTitle.value });
    };
    editJobDesc.oninput = async () => {
      const job = currentJob(); if(!job) return;
      await db.collection("jobs").doc(job.id).update({ description: editJobDesc.value });
    };

    addStageBtn.onclick = addStageFromInput;
    stageInput.addEventListener('keydown', (e)=>{
      if(e.key==='Enter'){ e.preventDefault(); addStageFromInput(); }
    });
    async function addStageFromInput(){
      const job = currentJob(); if(!job) return;
      const val = stageInput.value.trim();
      if(!val) return;
      if(job.stages.includes(val)){ alert('Etapa já existe.'); return; }
      const newStages = [...job.stages, val];
      await db.collection("jobs").doc(job.id).update({ stages: newStages });
      stageInput.value = '';
    }

    deleteJobBtn.onclick = async () => {
      const job = currentJob(); if(!job) return;
      if(!confirm(`Excluir a vaga "${job.title}"?`)) return;
      await db.collection("jobs").doc(job.id).delete();
      state.selectedJobId = null;
    };

    jobSearch.oninput = renderJobsList;

    /*************************
     * Ações (Candidatos)
     *************************/
    addCandBtn.onclick = async () => {
      const job = currentJob(); if(!job) return;
      const name = (candName.value||'').trim();
      if(!name){ alert('Informe o nome do candidato.'); return; }
      const contact = (candContact.value||'').trim();
      const cv = (candCV.value||'').trim();
      const notes = (candNotes.value||'').trim();
      const firstStage = job.stages[0] || "Recebidos";
      const newCandidate = cand(name, contact, cv, firstStage, notes);
      const updatedCandidates = [...job.candidates, newCandidate];
      await db.collection("jobs").doc(job.id).update({ candidates: updatedCandidates });
      candName.value = candContact.value = candCV.value = candNotes.value = '';
    };

    searchCand.oninput = ()=>{ const job = currentJob(); if(job) renderKanban(job); };

    async function moveCandidate(jobId, candId, stage){
      const job = state.jobs.find(j=>j.id===jobId);
      if(!job) return;
      const updatedCandidates = job.candidates.map(candidate => candidate.id === candId ? { ...candidate, stage } : candidate);
      await db.collection("jobs").doc(jobId).update({ candidates: updatedCandidates });
    }

    async function editCandidate(jobId, candId){
      const job = state.jobs.find(j=>j.id===jobId);
      const c = job?.candidates.find(x=>x.id===candId);
      if(!c) return;
      const name = prompt("Nome do candidato:", c.name);
      if(!name) return;
      const contact = prompt("Contato (email/telefone/@):", c.contact||'') ?? '';
      const cv = prompt("URL do currículo (opcional):", c.cv||'') ?? '';
      const notes = prompt("Observações:", c.notes||'') ?? '';
      const updatedCandidates = job.candidates.map(candidate => candidate.id === candId ? { ...candidate, name, contact, cv, notes } : candidate);
      await db.collection("jobs").doc(jobId).update({ candidates: updatedCandidates });
    }

    async function addNote(jobId, candId){
      const job = state.jobs.find(j=>j.id===jobId);
      const c = job?.candidates.find(x=>x.id===candId);
      if(!c) return;
      const extra = prompt("Adicionar observação:", "");
      if(extra){
        const newNotes = (c.notes? c.notes+"\n" : "") + "• " + extra;
        const updatedCandidates = job.candidates.map(candidate => candidate.id === candId ? { ...candidate, notes: newNotes } : candidate);
        await db.collection("jobs").doc(jobId).update({ candidates: updatedCandidates });
      }
    }

    async function deleteCandidate(jobId, candId){
      const job = state.jobs.find(j=>j.id===jobId);
      if(!job) return;
      const candObj = job.candidates.find(x=>x.id===candId);
      if(!candObj) return;
      if(!confirm(`Excluir o candidato "${candObj.name}"?`)) return;
      const updatedCandidates = job.candidates.filter(x=>x.id!==candId);
      await db.collection("jobs").doc(jobId).update({ candidates: updatedCandidates });
    }

    /********************
     * Export/Import
     ********************/
    exportBtn.onclick = ()=>{
      const blob = new Blob([JSON.stringify(state,null,2)], {type:'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `mini-ats-${new Date().toISOString().slice(0,10)}.json`;
      a.click();
      URL.revokeObjectURL(a.href);
    };
    importFile.onchange = (e)=>{
      const file = e.target.files?.[0];
      if(!file) return;
      const reader = new FileReader();
      reader.onload = ()=>{
        try{
          const data = JSON.parse(reader.result);
          if(!data || !Array.isArray(data.jobs)) throw new Error("Formato inválido.");
          data.jobs.forEach(job => db.collection("jobs").add(job));
        }catch(err){
          alert("Falha ao importar: " + err.message);
        }
      };
      reader.readAsText(file);
      e.target.value = '';
    };
    resetBtn.onclick = async ()=>{
      if(!confirm("Isto apagará todas as vagas e candidatos salvos no banco de dados. Continuar?")) return;
      const jobsRef = db.collection("jobs");
      const jobsSnapshot = await jobsRef.get();
      jobsSnapshot.docs.forEach(doc => doc.ref.delete());
    };

    /********************
     * Helpers
     ********************/
    function currentJob(){
      return state.jobs.find(j=>j.id===state.selectedJobId) || null;
    }
    function escapeHTML(str){ return (str??'').toString().replace(/[&<>"']/g, s=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[s])); }
    function escapeAttr(str){ return escapeHTML(str).replace(/"/g,'&quot;'); }
    function cssId(s){ return s.toLowerCase().replace(/\s+/g,'-').replace(/[^a-z0-9_-]/g,''); }

    // A aplicação é inicializada buscando os dados do Firebase em tempo real
    db.collection("jobs").onSnapshot((snapshot) => {
      state.jobs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      render();
    });
  </script>
</body>
</html>
